<html>
<head>

    <style type="text/stylesheet">
        @-webkit-viewport   { height: device-width; }
        @-moz-viewport      { height: device-width; }
        @-ms-viewport       { height: device-width; }
        @-o-viewport        { height: device-width; }
        @viewport           { height: device-width; }
    </style>
    <script type="text/javascript">
        //<![CDATA[
        if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
            let msViewportStyle = document.createElement("style");
            msViewportStyle.appendChild(
                document.createTextNode("@-ms-viewport{width:auto!important}")
            );
            document.getElementsByTagName("head")[0].appendChild(msViewportStyle);
        }
        //]]>
    </script>


    <script src="../../js/lib/jquery.min-1.11.1.js"></script>
    <script src="../../js/lib/jquery.json.min.js"></script>
    <script src="../../js/lib/jquery.cookie.js"></script>
    <script src="../../js/jquery-dataTables-1.10.1/js/jquery.dataTables-1.10.1.js"></script>
    <script src="../../js/jquery-ui-1.11.1.flick/jquery-ui.min.js"></script>
    <script src="../../js/compression/lz-string-1.4.4.js"></script>
    <script src="../../js/lib/handlebars-v4.0.5.js"></script>
    <script src="../../js/lib/canvas_wrapper.js"></script>
    <script src="../../js/loader_support.js"></script>
    <script src="../../js/alertifyjs/v1.0.10/alertify.js"></script>
    <link rel="stylesheet" type="text/css" href="../../js/jquery-dataTables-1.10.1/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="../../js/jquery-ui-1.11.1.flick/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="../../js/jquery-ui-1.11.1.flick/jquery-ui.structure.css">
    <link rel="stylesheet" type="text/css" href="../../js/jquery-ui-1.11.1.flick/jquery-ui.theme.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/virtuescope.css" media="screen"/>
    <style>
        body {
            font-family: FilsonProBook, sans-serif;
        }

        /* Fonts */
        @font-face {
            font-family: FilsonProBook;
            src: url("fonts/Filson_Pro_Book/Mostardesign_FilsonProBook.otf") format("opentype");
        }
    </style>
</head>
<body>

<div id="virtuescopeContainer" class="vs-row">
    <!-- UI Part -->
    <div id="canvasContainer" class="col-3">
        <canvas id="myCanvas" width="600" height="600"></canvas>
        <canvas id="triangle" width="90" height="50"></canvas>
        <div id="showAdvanced" title="Click for more options">+</div>
        <div id="advanced">
            <form>
                <span id="movement">Movement:</span>
                <select id="behaviour">
                    <option value="1">Deceleration</option>
                    <option value="2">Constant</option>
                    <option value="3">Crazy</option>
                </select>
                <!-- History -->
            </form>
            <a href="#" onclick="return hist.renderHistory()" id="showHist">Show history</a>
            <a href="#" onclick="return hist.deleteHistory()" id="delHist">Delete history</a>
            <a href="#" id="showImages" title="Cards with images will be displayed.">Show images</a>

            <div id="history"></div>
        </div>
        <div id="dialogueVs"></div>
    </div>
    <div id="yearPlanControls" class="col-9">

        <div class="vs-row">
            <div class="col-7" id="spinContainer">
                <!-- Wheel controls -->
            </div>
        </div>
        <div class="vs-row">
            <div class="col-12" id="textDisplay">
                <p id="introText"></p>
                <div id="virtuescopeContent"></div>
                <div id="runningMsg"></div>
            </div>
        </div>
        <div class="vs-row">
            <div class="col-7" id="plansFormDiv">
                <button id="startIt" class="btn-primary btn-lg">Play</button>
                <form id="plansForm"><select id="plans"></select></form>
                <button id="yearPlanRestart" onclick="yearPlan.restart()" class="">Restart</button>
                <img id="spinner" src="../../images/icons/spinner.gif"/>
            </div>
        </div>

    </div>

    <div class="vs-row">
        <div class="col-6">
            <h2 id="virtuescopePredictions">Virtuescope Predictions</h2>
        </div>
        <div class="col-6" id="sendButtons">
            <button id="yearPlanPdf" onclick="yearPlan.downloadPdf()">Download PDF</button>
            <button id="yearPlanMail">Send Email</button>
        </div>
        <div id="yearPlan">

        </div>
    </div>

</div>

<script src="../../js/global.js"></script>
<script src="../../js/util.js"></script>
<script src="../../js/en_GB.js"></script><!-- Replace for another language -->
<script src="../../js/plans.js"></script>
<script src="../../js/hist.js"></script>
<script src="../../js/anim.js"></script>
<script src="../../js/cookie_loader.js"></script>
<script src="../../js/init.js"></script>

<script type="text/javascript">

    ui.hasMobileWidth = function () {
        return jQuery(window).width() <= 1024;
    };

    // Overriding spinner behaviour
    var setSpinner = setInterval(function () {
        if (typeof spinnerVirtuescope !== "undefined") {
            spinnerVirtuescope.show = function () {
                jQuery("#spinner").show().css("display", "block").css("margin", "0 auto");
            };
            clearInterval(setSpinner);
        }
    }, 1000);

    // Changes to the style of the restart button
    yearPlan.showRestart = function () {
        var $yearPlanRestart = jQuery("#yearPlanRestart");
        if (!$yearPlanRestart.is(":visible")) {
            $yearPlanRestart.fadeIn("slow").css("display", "block");
        }
    };

    var origDisplayYearPlanEmail = yearPlan.displayYearPlanEmail;

    yearPlan.displayYearPlanEmail = function () {
        origDisplayYearPlanEmail();
        if (ui.hasMobileWidth()) {
            jQuery("#yearPlanMail").css("display", "block");
        }
    };

    var origDisplayYearPlanPdf = yearPlan.displayYearPlanPdf;

    yearPlan.displayYearPlanPdf = function () {
        origDisplayYearPlanPdf();
        if (ui.hasMobileWidth()) {
            jQuery("#yearPlanPdf").css("display", "block");
        }
    };

    yearPlan.downloadMail = function () {
        const restPath = "/../rest";
        var jsonData = yearPlan.prepareData();
        var last = yearPlan.countFill() - 1;
        alertify.parent(document.getElementById("yearPlanControls"));
        const plansSelect = jQuery("#plans");
        const defaultEmail = "john.doe@mail.com";
        const defaultErrorMessage = i18n["Email could not be sent (how embarassing !). Please download the PDF."];
        alertify
            .cancelBtn(i18n["Cancel"])
            .defaultValue(defaultEmail)
            .prompt(i18n["Virtuescope"] + " - " + plansSelect.find("option[value='" + plansSelect.val() + "']").text(),
                function (val, ev) {
                    // The click event is in the event variable, so you can use it here.
                    ev.preventDefault();

                    const toEmail = val;
                    if (!toEmail.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}/i) || toEmail === defaultEmail) {
                        alertify.error("This is no correct email address");
                    }
                    else {
                        jQuery.ajax({
                            type: 'GET',
                            jsonpCallback: 'jsonCallback',
                            url: global.urls.domain + global.urls.context + restPath + "/pdfgen/emailEncodedJsonp",
                            data: {json: yearPlan.encodeAndCompress(jsonData), lang: getGlobalLocale(), to: toEmail, plan: yearPlan.getPlanName()},
                            success: function (data) {
                                var reply = data.res;
                                if (reply === "OK") {
                                    alertify.success(i18n["Email sent successfully !"]);
                                }
                                else {
                                    alertify.error(defaultErrorMessage);
                                }
                            },
                            error: function () {
                                alertify.error(defaultErrorMessage);
                            },
                            async: true,
                            contentType: "application/json",
                            dataType: 'jsonp'
                        });
                    }
                }, function (ev) {
                    // Cancelled
                    ev.preventDefault();
                });
    };


</script>
</body>
</html>